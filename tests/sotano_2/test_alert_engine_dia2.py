"""
Test para AlertEngine - S√ìTANO 2 D√çA 2
======================================

Test de integraci√≥n para el motor de alertas avanzado en tiempo real.
Valida env√≠o, filtrado, priorizaci√≥n, canales de notificaci√≥n y m√©tricas.

Fecha: 2025-08-11
Componente: PUERTA-S2-ALERTS
Fase: D√çA 2 - Integraci√≥n MT5 Real-Time
"""

import sys
import os
from pathlib import Path
import unittest
import time
import threading
from datetime import datetime

# Configurar paths para imports
current_dir = Path(__file__).parent
project_root = current_dir.parent.parent
src_core = project_root / "src" / "core"
sys.path.insert(0, str(project_root.absolute()))
sys.path.insert(0, str(src_core.absolute()))

# Imports absolutos con validaci√≥n
try:
    # Importar desde src.core usando imports absolutos
    from src.core.config_manager import ConfigManager
    from src.core.logger_manager import LoggerManager  
    from src.core.error_manager import ErrorManager
    
    # Import del AlertEngine desde real_time
    from src.core.real_time.alert_engine import AlertEngine, AlertPriority, AlertChannel, Alert
    
except ImportError as e:
    print(f"‚ùå Error importando dependencias: {e}")
    print("Nota: Aseg√∫rate de que todos los componentes S√ìTANO 1 est√©n disponibles")
    sys.exit(1)


def test_alert_engine_basic():
    """Test b√°sico de AlertEngine"""
    print("\nüß™ TEST ALERT ENGINE - D√çA 2 S√ìTANO 2")
    print("=" * 50)
    
    try:
        # Test 1: Import exitoso
        print("‚úÖ Import AlertEngine: OK")
        
        # Test 2: Crear dependencias S√ìTANO 1
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        print("‚úÖ Dependencias S√ìTANO 1: OK")
        
        # Test 3: Inicializar AlertEngine
        engine = AlertEngine(config, logger, error)
        assert engine.component_id == "PUERTA-S2-ALERTS", "Component ID incorrecto"
        assert engine.version == "v2.1.0", "Versi√≥n incorrecta"
        print(f"‚úÖ Inicializaci√≥n: {engine.component_id}")
        print(f"‚úÖ Versi√≥n: {engine.version}")
        
        # Test 4: Verificar dependencias conectadas
        assert engine.config is not None, "PUERTA-S1-CONFIG no conectada"
        assert engine.logger is not None, "PUERTA-S1-LOGGER no conectada"
        assert engine.error is not None, "PUERTA-S1-ERROR no conectada"
        print("‚úÖ PUERTA-S1-CONFIG: Conectada")
        print("‚úÖ PUERTA-S1-LOGGER: Conectada")
        print("‚úÖ PUERTA-S1-ERROR: Conectada")
        
        # Test 5: Verificar configuraci√≥n
        assert hasattr(engine, 'alert_config'), "Configuraci√≥n no inicializada"
        assert 'enabled' in engine.alert_config, "Configuraci√≥n b√°sica faltante"
        assert 'default_channels' in engine.alert_config, "Canales por defecto faltantes"
        print(f"‚úÖ Configuraci√≥n: {len(engine.alert_config)} par√°metros")
        print(f"‚úÖ Canales default: {len(engine.alert_config['default_channels'])}")
        
        # Test 6: Estado inicial
        status = engine.get_status()
        assert status['is_running'] == False, "Estado inicial incorrecto"
        assert status['component_id'] == "PUERTA-S2-ALERTS", "Component ID en status incorrecto"
        print("‚úÖ Estado inicial: No running (correcto)")
        print(f"‚úÖ Status keys: {len(status)} propiedades")
        
        # Test 7: M√©tricas iniciales
        metrics = engine.get_metrics()
        assert metrics['total_alerts_received'] == 0, "M√©tricas iniciales incorrectas"
        assert metrics['alerts_acknowledged'] == 0, "Alert count inicial incorrecto"
        print("‚úÖ M√©tricas iniciales: OK")
        
        # Test 8: Enums y tipos
        assert AlertPriority.HIGH.value == "high", "Enum AlertPriority incorrecto"
        assert AlertChannel.LOG.value == "log", "Enum AlertChannel incorrecto"
        print("‚úÖ Enums y tipos: OK")
        
        print("\nüéâ ALERT ENGINE B√ÅSICO D√çA 2: ‚úÖ COMPLETADO")
        print("üéØ Motor de alertas inicializado correctamente")
        print("üîó Integraci√≥n S√ìTANO 1 validada")
        
    except Exception as e:
        print(f"\n‚ùå ERROR en test AlertEngine: {e}")
        import traceback
        traceback.print_exc()
        raise AssertionError(f"Test AlertEngine failed: {e}")


def test_alert_sending_and_management():
    """Test de env√≠o y manejo de alertas"""
    print("\nüì® TEST ALERT SENDING AND MANAGEMENT")
    print("-" * 50)
    
    try:
        # Crear componentes
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        engine = AlertEngine(config, logger, error)
        
        # Test env√≠o de alerta b√°sica
        alert_id = engine.send_alert(
            priority=AlertPriority.HIGH,
            category="test",
            title="Test Alert",
            message="Esta es una alerta de prueba",
            data={"test_value": 123}
        )
        
        assert alert_id != "", "Alert ID no generado"
        print(f"‚úÖ Alerta enviada: {alert_id}")
        
        # Verificar m√©tricas actualizadas
        metrics = engine.get_metrics()
        assert metrics['total_alerts_received'] == 1, "M√©trica no actualizada"
        assert metrics['alerts_by_priority']['high'] == 1, "Prioridad no contada"
        print("‚úÖ M√©tricas actualizadas: OK")
        
        # Test obtener alertas activas
        active_alerts = engine.get_active_alerts()
        assert len(active_alerts) == 1, "Alerta no agregada a activas"
        assert active_alerts[0].id == alert_id, "ID de alerta no coincide"
        assert active_alerts[0].priority == AlertPriority.HIGH, "Prioridad no coincide"
        print("‚úÖ Alerta activa: Verificada")
        
        # Test reconocer alerta
        result = engine.acknowledge_alert(alert_id)
        assert result == True, "Acknowledge fall√≥"
        assert active_alerts[0].acknowledged == True, "Alerta no marcada como acknowledged"
        print("‚úÖ Acknowledge: OK")
        
        # Test resolver alerta
        result = engine.resolve_alert(alert_id)
        assert result == True, "Resolve fall√≥"
        
        # Verificar que se movi√≥ al historial
        active_alerts = engine.get_active_alerts()
        assert len(active_alerts) == 0, "Alerta no removida de activas"
        
        history = engine.get_alert_history()
        assert len(history) == 1, "Alerta no agregada al historial"
        print("‚úÖ Resolve: OK")
        
        # Test m√∫ltiples alertas
        for i in range(3):
            engine.send_alert(
                priority=AlertPriority.MEDIUM,
                category=f"test_{i}",
                title=f"Test Alert {i}",
                message=f"Mensaje {i}"
            )
        
        active_alerts = engine.get_active_alerts()
        assert len(active_alerts) == 3, "M√∫ltiples alertas no enviadas"
        print("‚úÖ M√∫ltiples alertas: OK")
        
    except Exception as e:
        print(f"‚ùå Error en test de alertas: {e}")
        raise AssertionError(f"Test alert sending failed: {e}")


def test_notification_channels():
    """Test del sistema de canales de notificaci√≥n"""
    print("\nüì¢ TEST NOTIFICATION CHANNELS")
    print("-" * 50)
    
    try:
        # Crear componentes
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        engine = AlertEngine(config, logger, error)
        
        # Test suscripci√≥n a canales
        log_notifications = []
        email_notifications = []
        
        def log_callback(alert: Alert):
            log_notifications.append(f"LOG:{alert.title}")
            
        def email_callback(alert: Alert):
            email_notifications.append(f"EMAIL:{alert.title}")
            
        engine.subscribe_channel(AlertChannel.LOG, log_callback)
        engine.subscribe_channel(AlertChannel.EMAIL, email_callback)
        print("‚úÖ Callbacks suscritos: LOG, EMAIL")
        
        # Test env√≠o con canal espec√≠fico
        alert_id = engine.send_alert(
            priority=AlertPriority.CRITICAL,
            category="notification_test",
            title="Test Notification",
            message="Test de notificaciones",
            channels=[AlertChannel.LOG, AlertChannel.EMAIL]
        )
        
        # Esperar procesamiento
        time.sleep(0.1)
        
        # Verificar notificaciones recibidas
        assert "LOG:Test Notification" in log_notifications, "Notificaci√≥n LOG no recibida"
        assert "EMAIL:Test Notification" in email_notifications, "Notificaci√≥n EMAIL no recibida"
        print("‚úÖ Notificaciones enviadas: LOG, EMAIL")
        
        # Test desuscripci√≥n
        engine.unsubscribe_channel(AlertChannel.LOG, log_callback)
        
        # Enviar otra alerta
        engine.send_alert(
            priority=AlertPriority.LOW,
            category="notification_test",
            title="Test Notification 2",
            message="Segunda notificaci√≥n",
            channels=[AlertChannel.LOG, AlertChannel.EMAIL]
        )
        
        time.sleep(0.1)
        
        # Solo EMAIL deber√≠a haber recibido la segunda
        assert "EMAIL:Test Notification 2" in email_notifications, "Segunda notificaci√≥n EMAIL no recibida"
        assert "LOG:Test Notification 2" not in log_notifications, "LOG recibi√≥ notificaci√≥n despu√©s de desuscribirse"
        print("‚úÖ Desuscripci√≥n: Funcional")
        
    except Exception as e:
        print(f"‚ùå Error en test de canales: {e}")
        raise AssertionError(f"Test notification channels failed: {e}")


def test_filtering_and_throttling():
    """Test de filtrado y throttling"""
    print("\nüö¶ TEST FILTERING AND THROTTLING")
    print("-" * 50)
    
    try:
        # Crear componentes
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        engine = AlertEngine(config, logger, error)
        
        # Configurar throttling corto para testing
        engine.alert_config["throttle_seconds"] = 1
        
        # Test filtro personalizado
        def test_filter(alert: Alert) -> bool:
            # Filtrar alertas que contienen "SPAM"
            return "SPAM" in alert.title
            
        engine.add_filter(test_filter)
        print("‚úÖ Filtro personalizado agregado")
        
        # Test: alerta normal deber√≠a pasar
        alert_id1 = engine.send_alert(
            priority=AlertPriority.MEDIUM,
            category="filter_test",
            title="Normal Alert",
            message="Esta deber√≠a pasar"
        )
        
        assert alert_id1 != "", "Alerta normal no pas√≥ el filtro"
        print("‚úÖ Alerta normal: Pas√≥ filtro")
        
        # Test: alerta con SPAM deber√≠a ser filtrada
        alert_id2 = engine.send_alert(
            priority=AlertPriority.HIGH,
            category="filter_test",
            title="SPAM Alert",
            message="Esta deber√≠a ser filtrada"
        )
        
        assert alert_id2 == "", "Alerta SPAM no fue filtrada"
        print("‚úÖ Filtro SPAM: Funcional")
        
        # Test throttling - enviar la misma alerta dos veces r√°pido
        alert_id3 = engine.send_alert(
            priority=AlertPriority.LOW,
            category="throttle_test",
            title="Throttle Test",
            message="Primera vez"
        )
        
        alert_id4 = engine.send_alert(
            priority=AlertPriority.LOW,
            category="throttle_test",
            title="Throttle Test",
            message="Segunda vez (deber√≠a ser throttled)"
        )
        
        assert alert_id3 != "", "Primera alerta throttle no enviada"
        assert alert_id4 == "", "Segunda alerta no fue throttled"
        print("‚úÖ Throttling: Funcional")
        
        # Verificar m√©tricas de filtrado
        metrics = engine.get_metrics()
        assert metrics['alerts_filtered'] >= 2, "M√©tricas de filtrado incorrectas"
        print("‚úÖ M√©tricas de filtrado: Actualizadas")
        
    except Exception as e:
        print(f"‚ùå Error en test de filtrado: {e}")
        raise AssertionError(f"Test filtering failed: {e}")


def test_engine_lifecycle():
    """Test del ciclo de vida del motor"""
    print("\nüîÑ TEST ENGINE LIFECYCLE")
    print("-" * 50)
    
    try:
        # Crear componentes
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        engine = AlertEngine(config, logger, error)
        
        # Test estado inicial
        status = engine.get_status()
        assert status['is_running'] == False, "Estado inicial incorrecto"
        print("‚úÖ Estado inicial: Parado")
        
        # Test iniciar motor
        result = engine.start_engine()
        assert result == True, "Motor no se pudo iniciar"
        assert engine.is_running == True, "Estado is_running incorrecto"
        print("‚úÖ Motor iniciado: OK")
        
        # Esperar un poco para que el thread se establezca
        time.sleep(0.5)
        
        # Test enviar alertas con motor ejecut√°ndose
        alert_id = engine.send_alert(
            priority=AlertPriority.CRITICAL,
            category="lifecycle_test",
            title="Test con motor ejecut√°ndose",
            message="Motor activo"
        )
        
        assert alert_id != "", "Alerta no enviada con motor activo"
        print("‚úÖ Alerta con motor activo: OK")
        
        # Test detener motor
        result = engine.stop_engine()
        assert result == True, "Motor no se pudo detener"
        assert engine.is_running == False, "Estado despu√©s de stop incorrecto"
        print("‚úÖ Motor detenido: OK")
        
        # Verificar que las alertas siguen funcionando (sin auto-resolve)
        alert_id2 = engine.send_alert(
            priority=AlertPriority.LOW,
            category="lifecycle_test",
            title="Test con motor parado",
            message="Motor inactivo"
        )
        
        assert alert_id2 != "", "Alerta no enviada con motor parado"
        print("‚úÖ Alerta con motor parado: OK")
        
    except Exception as e:
        print(f"‚ùå Error en test de ciclo de vida: {e}")
        raise AssertionError(f"Test lifecycle failed: {e}")


def main():
    """Funci√≥n principal de testing"""
    print("=" * 60)
    print("üèóÔ∏è S√ìTANO 2 - D√çA 2: ALERT ENGINE")
    print("PUERTA-S2-ALERTS - Test de integraci√≥n")
    print("=" * 60)
    
    # Ejecutar tests
    test_results = []
    
    try:
        # Test 1: Funcionalidad b√°sica
        test_alert_engine_basic()
        test_results.append(True)
    except Exception:
        test_results.append(False)
    
    try:
        # Test 2: Env√≠o y manejo de alertas
        test_alert_sending_and_management()
        test_results.append(True)
    except Exception:
        test_results.append(False)
    
    try:
        # Test 3: Canales de notificaci√≥n
        test_notification_channels()
        test_results.append(True)
    except Exception:
        test_results.append(False)
    
    try:
        # Test 4: Filtrado y throttling
        test_filtering_and_throttling()
        test_results.append(True)
    except Exception:
        test_results.append(False)
    
    try:
        # Test 5: Ciclo de vida del motor
        test_engine_lifecycle()
        test_results.append(True)
    except Exception:
        test_results.append(False)
    
    # Test 6: Compatibilidad con sistema existente
    print("\nüîÑ TEST COMPATIBILIDAD CON SISTEMA EXISTENTE")
    print("-" * 50)
    try:
        # Verificar que el sistema S√ìTANO 1 sigue funcionando
        from src.core.analytics_manager import AnalyticsManager
        from src.core.data_manager import DataManager
        config = ConfigManager()
        logger = LoggerManager()
        error = ErrorManager(logger)
        data_manager = DataManager(config, logger, error)
        analytics = AnalyticsManager(config, logger, error, data_manager)
        print("‚úÖ Sistema S√ìTANO 1 sigue funcionando")
        print("‚úÖ No hay conflictos con S√ìTANO 2")
        test_results.append(True)
    except Exception as e:
        print(f"‚ùå Error de compatibilidad: {e}")
        test_results.append(False)
    
    # Resumen
    print("\n" + "=" * 60)
    print("üìä RESUMEN D√çA 2 - ALERT ENGINE")
    print("=" * 60)
    tests_passed = sum(test_results)
    tests_total = len(test_results)
    
    print(f"Tests ejecutados: {tests_total}")
    print(f"Tests pasados: {tests_passed}")
    print(f"Tests fallidos: {tests_total - tests_passed}")
    
    if tests_passed == tests_total:
        print("\nüéâ D√çA 2 - ALERT ENGINE: ‚úÖ COMPLETADO")
        print("‚úÖ PUERTA-S2-ALERTS: Funcional")
        print("‚úÖ Integraci√≥n S√ìTANO 1: Sin conflictos")
        print("‚úÖ Sistema de notificaciones: Funcional")
        print("‚úÖ Filtrado y throttling: Funcional")
        print("‚úÖ Ciclo de vida: Funcional")
        print("üéØ PR√ìXIMO: Performance Tracker - Seguimiento de rendimiento")
        assert tests_passed == tests_total, f"Tests fallidos: {tests_total - tests_passed}"
    else:
        print(f"\n‚ùå D√çA 2 CON PROBLEMAS")
        print("üîß Revisar implementaci√≥n antes de continuar")
        raise AssertionError(f"Tests fallidos: {tests_total - tests_passed}")


if __name__ == "__main__":
    main()
